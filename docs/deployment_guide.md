# 云部署方案指南

## 总体架构

```
用户手机 → CDN → 前端(静态网站) → 后端API(云函数/服务器) → 第三方API(通义千问/flomo)
```

## 推荐方案对比

| 方案 | 前端部署 | 后端部署 | 月成本估算 | 适用场景 |
|------|---------|---------|-----------|----------|
| **方案A（推荐）** | 腾讯云静态网站托管 | 腾讯云函数SCF | 0-20元 | 个人使用，流量不大 |
| **方案B** | 阿里云OSS+CDN | 阿里云函数计算FC | 0-30元 | 稳定性要求高 |
| **方案C** | Gitee Pages | 腾讯云轻量服务器 | 40-80元 | 需要完全控制 |

---

## 方案A：腾讯云全家桶（推荐）

### 成本分析
- **前端（静态网站托管）**：免费额度1GB存储 + 1GB/月流量
- **后端（云函数SCF）**：免费额度100万次调用/月 + 40万GBs计算资源
- **域名**：可选，.com域名约55元/年
- **SSL证书**：腾讯云免费DV证书

**预计月成本：0-20元（超出免费额度才计费）**

### 具体部署步骤

#### 第一步：准备工作
1. **注册腾讯云账号**：[https://cloud.tencent.com](https://cloud.tencent.com)
2. **实名认证**：上传身份证完成认证
3. **开通服务**：
   - 静态网站托管
   - 云函数 SCF
   - 域名服务（可选）

#### 第二步：后端部署（云函数）
1. **创建云函数**：
   - 运行环境：Python 3.9
   - 函数名称：`note-agent-api`
   - 触发器：API网关触发器

2. **代码准备**：
   ```bash
   # 需要将后端代码打包
   cd NoteFlow/backend
   pip install -r requirements.txt -t ./
   zip -r note-agent-api.zip .
   ```

3. **环境变量配置**：
   - `DASHSCOPE_API_KEY`: 通义千问API密钥
   - `FLMO_WEBHOOK_URL`: flomo webhook地址

4. **部署配置**：
   - 内存：512MB
   - 超时时间：60秒
   - 并发数：100

#### 第三步：前端部署（静态网站托管）
1. **构建前端**：
   ```bash
   cd NoteFlow/frontend
   npm run build
   ```

2. **上传到静态网站托管**：
   - 上传 `dist` 文件夹内容
   - 配置默认首页：`index.html`
   - 配置错误页面：`index.html`（支持SPA路由）

3. **配置API代理**：
   - 在静态网站托管中配置反向代理
   - 将 `/api/*` 代理到云函数的API网关地址

#### 第四步：域名配置（可选）
1. **购买域名**：
   - 在腾讯云域名服务购买
   - 或使用已有域名

2. **SSL证书**：
   - 申请免费DV证书
   - 绑定到静态网站托管

3. **备案**：
   - 如使用国内服务器，需要备案
   - 备案时间约1-2周

---

## 方案B：阿里云方案

### 成本分析
- **前端（OSS+CDN）**：OSS存储包6元/年 + CDN流量包约20元/年
- **后端（函数计算FC）**：免费额度100万次调用/月
- **域名**：.com域名约55元/年

**预计年成本：80-150元**

### 部署步骤
1. **OSS对象存储**：上传前端构建文件
2. **CDN加速**：配置CDN加速OSS存储
3. **函数计算FC**：部署后端API
4. **API网关**：配置API路由和鉴权

---

## 方案C：混合方案

### 适用场景
- 对成本不敏感
- 需要完全控制后端环境
- 有一定运维能力

### 部署方案
- **前端**：Gitee Pages（免费）
- **后端**：腾讯云轻量应用服务器（40元/月起）

---

## 部署准备清单

### 代码修改需求
1. **后端环境变量化**：
   ```python
   # 将所有配置改为环境变量
   DASHSCOPE_API_KEY = os.getenv("DASHSCOPE_API_KEY")
   FLMO_WEBHOOK_URL = os.getenv("FLMO_WEBHOOK_URL")
   ```

2. **前端API地址配置**：
   ```javascript
   // 根据环境自动切换API地址
   const API_BASE_URL = process.env.NODE_ENV === 'production' 
     ? 'https://你的域名/api' 
     : '/api';
   ```

3. **云函数适配**：
   ```python
   # 需要将FastAPI适配为云函数处理函数
   from mangum import Mangum
   handler = Mangum(app)
   ```

### 文件结构优化
```
NoteFlow/
├── frontend/
│   ├── dist/           # 构建产物（部署到静态托管）
│   └── src/
├── backend/
│   ├── main.py         # 云函数入口
│   ├── requirements.txt
│   └── package.zip     # 云函数部署包
└── docs/
    └── deployment_guide.md
```

---

## 注意事项

### 网络安全
1. **API密钥安全**：
   - 使用云服务商的密钥管理服务
   - 不要在代码中硬编码密钥

2. **HTTPS强制**：
   - 所有生产环境必须使用HTTPS
   - 配置HSTS头部

### 性能优化
1. **前端优化**：
   - 启用CDN加速
   - 配置Gzip压缩
   - 设置合理的缓存策略

2. **后端优化**：
   - 云函数冷启动优化
   - 合理设置并发限制
   - 添加请求日志和监控

### 成本控制
1. **监控用量**：
   - 设置账单报警
   - 定期检查资源使用情况

2. **合理配额**：
   - 设置API调用限制
   - 配置云函数超时和内存限制

---

## 部署时间表

| 阶段 | 预计时间 | 主要工作 |
|------|---------|----------|
| 准备阶段 | 1天 | 注册账号、实名认证、开通服务 |
| 后端部署 | 1-2天 | 代码修改、打包、云函数部署 |
| 前端部署 | 半天 | 构建、上传、配置 |
| 域名配置 | 1天 | 域名购买、SSL申请、解析配置 |
| 备案（可选） | 1-2周 | 提交备案材料、等待审核 |
| 测试验收 | 1天 | 全流程测试、性能优化 |

**总计：1周-3周（含备案）**

---

## 文档导航

本目录包含以下部署相关文档：

1. **[deployment_guide.md](./deployment_guide.md)**（本文档）：总体方案概览
2. **[step_by_step_guide.md](./step_by_step_guide.md)**：详细分步操作指南
3. **[cost_analysis.md](./cost_analysis.md)**：成本分析和方案对比
4. **[deployment_manual.md](./deployment_manual.md)**：云函数入口代码

---

## 下一步行动

1. **选择方案**：根据需求和预算选择具体方案
2. **注册账号**：完成云服务商注册和认证
3. **阅读详细指南**：参考 `step_by_step_guide.md`
4. **开始部署**：按步骤执行部署流程

**推荐从方案A开始**，因为腾讯云的免费额度对个人项目足够，且文档相对完善。 